# Copyright 2023-2025 RnD Center "ELVEES", JSC
# SPDX-License-Identifier: MIT

.globl int_return

.set noat
.text
Interrupt:

/* Сместить указатель стека на 31*4+24 байта вниз */
    addiu      $29,$29,-(31*4+24)
/* Сохранить в стеке регистры 1-28,30,31 */
    sw         $1,(0)($29)
    sw         $2,(4)($29)
    sw         $3,(8)($29)
    sw         $4,(12)($29)
    sw         $5,(16)($29)
    sw         $6,(20)($29)
    sw         $7,(24)($29)
    sw         $8,(28)($29)
    sw         $9,(32)($29)
    sw         $10,(36)($29)
    sw         $11,(40)($29)
    sw         $12,(44)($29)
    sw         $13,(48)($29)
    sw         $14,(52)($29)
    sw         $15,(56)($29)
    sw         $16,(60)($29)
    sw         $17,(64)($29)
    sw         $18,(68)($29)
    sw         $19,(72)($29)
    sw         $20,(76)($29)
    sw         $21,(80)($29)
    sw         $22,(84)($29)
    sw         $23,(88)($29)
    sw         $24,(92)($29)
    sw         $25,(96)($29)
    sw         $26,(100)($29)
    sw         $27,(104)($29)
    sw         $28,(108)($29)
    sw         $30,(112)($29)
    sw         $31,(116)($29)

    /* Вызов функции непосредственно обработчика */

    la   $26, risc_common_handler
    jalr  $26
    nop

/* Восстановить регистры 1-28,30,31 из стека */
    lw         $1,(0)($29)
    lw         $2,(4)($29)
    lw         $3,(8)($29)
    lw         $4,(12)($29)
    lw         $5,(16)($29)
    lw         $6,(20)($29)
    lw         $7,(24)($29)
    lw         $8,(28)($29)
    lw         $9,(32)($29)
    lw         $10,(36)($29)
    lw         $11,(40)($29)
    lw         $12,(44)($29)
    lw         $13,(48)($29)
    lw         $14,(52)($29)
    lw         $15,(56)($29)
    lw         $16,(60)($29)
    lw         $17,(64)($29)
    lw         $18,(68)($29)
    lw         $19,(72)($29)
    lw         $20,(76)($29)
    lw         $21,(80)($29)
    lw         $22,(84)($29)
    lw         $23,(88)($29)
    lw         $24,(92)($29)
    lw         $25,(96)($29)
    lw         $26,(100)($29)
    lw         $27,(104)($29)
    lw         $28,(108)($29)
    lw         $30,(112)($29)
    lw         $31,(116)($29)
/* Восстановить указатель стека */
    addiu      $29,$29,31*4+24

/* Возврат из прерывания */
    eret
    nop
